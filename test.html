<!doctype html>
<html>
   <head>
      <meta charset="utf-8">
      <title>wat</title>
   </head>
   <body contenteditable="true">
	   <a href="https://developer.mozilla.org/en-US/docs/WebAssembly/Reference">https://developer.mozilla.org/en-US/docs/WebAssembly/Reference</a>
	  <div id="x"></div>
	  <a href="https://webassembly.org/getting-started/advanced-tools/">https://webassembly.org/getting-started/advanced-tools/</a>
      <script> 
         let sum; 
var wasm;
var term;

function mem2string(ptr)
{
     	let len = 0;
     	let hl = 0;
     	const head = new Uint8Array(wasm.exports.memory.buffer, ptr, 4);
     	if (head[0] < 0xC0) {
		len = head[0];
		hl = 1;
     	} else if (head[0] < 0xE0) {
		len = head[0] & 0x1F;
		len <<= 6;
		len += head[1] & 0x3F;
		hl = 2;
     	} else if (head[0] < 0xF0) {
		len = head[0] & 0x0F;
		len <<= 6;
		len += head[1] & 0x3F;
		len <<= 6;
		len += head[2] & 0x3F;
		hl = 3;
     	} else {
		len = head[0] & 0x07;
		len <<= 6;
		len += head[1] & 0x3F;
		len <<= 6;
		len += head[2] & 0x3F;
		len <<= 6;
		len += head[3] & 0x3F;
		hl = 4;
     	}
      	const bytes = new Uint8Array(wasm.exports.memory.buffer, ptr + hl, len);
      	return new TextDecoder('utf-8').decode(bytes);
}
function keyboard(e)
{
	let seq = e.data;
	e.preventDefault();
	if (seq == "\r") {
		seq = "\r\n";
	}
	if (seq == "\x1B") {
		//process.exit(0);
	}
        let u = new TextEncoder('utf-8').encode(seq);
	let s = u.length;
	let a = new Uint32Array(wasm.exports.memory.buffer, term, 6);
	let si = new Uint8Array(wasm.exports.memory.buffer, term + 4 * 6, 1);
	let d = new Uint8Array(wasm.exports.memory.buffer, term + 4 * 6+1, 127);
	if (s > 127) {
		s = 127;
	}
	si[0] = s;
	for (i = 0; i < s; i++) {
		d[i] = u[i]
	}
	a[3] = 1; /* event type */
	a[4] = s; /* event data length */
	a[5] = term + 4 * 6; /* event data pointer */
	wasm.exports.event(term);
}

	 function print(ptr)
{
    		document.getElementById("x").innerText += mem2string(ptr);
}
function timeout()
{
	let d = new Uint8Array(wasm.exports.memory.buffer, term + 4 * 6, 1);
	d[0] = 0;
	wasm.exports.event(term);
        setTimeout(timeout,100);
}

 const imp = {
	std: {
		print: print,
	},
};

         fetch("test.cmd")
            .then(bytes => bytes.arrayBuffer()) 
            .then(mod => WebAssembly.compile(mod.slice(128))) .then(module => {
            
            return new WebAssembly.Instance(module,imp);
         })
         .then(instance => {
		 wasm = instance;
		 term = wasm.exports.term__new();
		 document.body.addEventListener("input", keyboard);
		 setTimeout(timeout,100);
            sum = instance.exports.add(10,40); 
    		document.getElementById("x").innerHTML = "10 + 40 = " + sum; 
         }); 
      </script>
   </body>
</html>

